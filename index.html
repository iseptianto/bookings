<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOKING RESTAURANT</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQZHXLlvWZOJyj7Yy7tcenmpD1ypASozpmTE/iPtmFIB46ZmdtAc9eNBvH0H/Zpisbw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- ‚úÖ NO VAPI SCRIPT HERE - We load it manually in JavaScript -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, rgb(160, 160, 160) 0%, rgb(255, 255, 255) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        body.teal-theme {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
        }

        body.iframe-mode {
            background: transparent !important;
        }

        body.iframe-mode .header {
            border-radius: 10px;
        }

        body.iframe-mode .container {
            background: white;
            box-shadow: none;
            border-radius: 0;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        body.teal-theme .header {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .form-container {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        body.teal-theme .form-group input:focus {
            border-color: #14b8a6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .time-slots-container {
            margin-top: 20px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .time-slot {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            font-size: 14px;
            font-weight: 500;
        }

        .time-slot:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        body.teal-theme .time-slot:hover {
            border-color: #14b8a6;
        }

        .time-slot.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        body.teal-theme .time-slot.selected {
            border-color: #14b8a6;
            background: #14b8a6;
        }

        .time-slot.disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
            border-color: #d1d5db;
        }

        .time-slot.disabled:hover {
            border-color: #d1d5db;
            background: #f3f4f6;
        }

        .time-slot.booked {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
            cursor: not-allowed;
        }

        .time-slot.booked:hover {
            border-color: #fecaca;
            background: #fef2f2;
        }

        .btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        body.teal-theme .btn {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            margin-top: 10px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-whatsapp:hover {
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            transform: translateY(-2px);
        }

        .btn-whatsapp i {
            margin-right: 8px;
            font-size: 18px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #dc2626;
        }

        .toast.warning {
            background: #f59e0b;
        }

        .toast.success {
            background: #059669;
        }

        body.teal-theme .toast.success {
            background: #0d9488;
        }

        .toast i {
            margin-right: 8px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading .time-slot {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .business-hours {
            margin-top: 20px;
            padding: 15px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            font-size: 14px;
            color: #1e40af;
        }

        body.teal-theme .business-hours {
            background: #ccfbf1;
            border: 1px solid #5eead4;
            color: #0f766e;
        }

        .business-hours h4 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .business-hours ul {
            margin-left: 20px;
        }

        .business-hours li {
            margin-bottom: 4px;
        }

        .test-scenarios {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        body.teal-theme .test-scenarios {
            display: none;
        }

        .test-scenarios h3 {
            margin-bottom: 15px;
            color: #374151;
        }

        .scenario-btn {
            display: inline-block;
            margin: 5px;
            padding: 8px 12px;
            background: #e5e7eb;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .scenario-btn:hover {
            background: #d1d5db;
        }

        .scenario-btn.success {
            background: #dcfce7;
            color: #166534;
        }

        .scenario-btn.error {
            background: #fef2f2;
            color: #dc2626;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        body.teal-theme .toggle-switch.active {
            background: #14b8a6;
        }

        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-knob {
            transform: translateX(30px);
        }

        .toggle-label {
            font-weight: 500;
            color: #374151;
            font-size: 16px;
        }

        .toggle-label.active {
            color: #667eea;
        }

        body.teal-theme .toggle-label.active {
            color: #14b8a6;
        }

        .chat-container {
            display: none;
            height: 500px;
            flex-direction: column;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 400px;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-message .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .chat-message.user .avatar {
            background: #667eea;
        }

        body.teal-theme .chat-message.user .avatar {
            background: #14b8a6;
        }

        .chat-message.bot .avatar {
            background: #6b7280;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .chat-message.user .chat-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 6px;
        }

        body.teal-theme .chat-message.user .chat-bubble {
            background: #14b8a6;
        }

        .chat-message.bot .chat-bubble {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 6px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        body.teal-theme .chat-input:focus {
            border-color: #14b8a6;
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        body.teal-theme .chat-send-btn {
            background: #14b8a6;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            margin-bottom: 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            max-width: 80%;
            color: #6b7280;
        }

        .typing-indicator.show {
            display: block;
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .chat-bubble h1,
        .chat-bubble h2,
        .chat-bubble h3 {
            margin: 8px 0 4px 0;
            color: inherit;
        }

        .chat-bubble h1 {
            font-size: 18px;
        }

        .chat-bubble h2 {
            font-size: 16px;
        }

        .chat-bubble h3 {
            font-size: 14px;
        }

        .chat-bubble p {
            margin: 6px 0;
            line-height: 1.4;
        }

        .chat-bubble strong {
            font-weight: 600;
        }

        .chat-bubble a {
            color: #2563eb;
            text-decoration: none;
        }

        .chat-bubble a:hover {
            text-decoration: underline;
        }

        .chat-bubble ul,
        .chat-bubble ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .chat-bubble li {
            margin: 4px 0;
        }

        .chat-bubble code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .chat-bubble pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .chat-bubble blockquote {
            border-left: 3px solid #e5e7eb;
            padding-left: 12px;
            margin: 8px 0;
            color: #6b7280;
        }

        .floating-call-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: transform 0.2s, background 0.3s;
            border: none;
        }

        .floating-call-btn:hover {
            transform: scale(1.1);
        }

        .floating-call-btn:active {
            transform: scale(0.95);
        }

        .floating-call-btn.calling {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 20px rgba(220, 38, 38, 0.5);
            }
        }

        .call-status {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 999;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .call-status.active {
            display: flex;
        }

        .call-status .indicator {
            width: 10px;
            height: 10px;
            background: #dc2626;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .call-status.listening .indicator {
            background: #059669;
        }

        .call-status.speaking .indicator {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-utensils"></i> Booking Restaurant</h1>
            <p>Welcome to our Table Reservation service. Here, you can book a table for a dinner, birthday celebration, or any other special event. Simply enter your name, email, and other details, and all confirmations will be automatically saved to your Google Calendar. If you need further assistance, feel free to contact us via WhatsApp.</p>
        </div>

        <div class="form-container">
            <div class="toggle-container">
                <span class="toggle-label active" id="form-label">Booking Form</span>
                <div class="toggle-switch" id="mode-toggle">
                    <div class="toggle-knob"></div>
                </div>
                <span class="toggle-label" id="chat-label">Chat Assistant</span>
            </div>

            <form id="booking-form">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" placeholder="+62123456789" required>
                </div>

                <div class="form-group">
                    <label for="date">Select Date</label>
                    <input type="date" id="date" name="date" required min="">
                </div>

                <div class="form-group">
                    <label>Available Time Slots</label>
                    <div class="time-slots-container">
                        <div class="time-slots-grid" id="time-slots-grid">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="partysize">Party Size</label>
                    <input type="number" id="partysize" name="partysize" min="1" max="20" value="4" required>
                </div>

                <div class="form-group">
                    <label for="allergies">Allergies (Optional)</label>
                    <input type="text" id="allergies" name="allergies" placeholder="e.g., Peanuts, Seafood">
                </div>

                <div class="form-group">
                    <label for="notes">Special Requests (Optional)</label>
                    <input type="text" id="notes" name="notes" placeholder="Window seat, birthday celebration, etc.">
                </div>

                <button type="submit" class="btn" id="submit-btn">
                    <i class="fas fa-paper-plane"></i> Submit Booking
                </button>

                <a href="https://api.whatsapp.com/send?phone=6287781396076&text=type+phone+number+app+absent+0&utm_source=heylink.me" target="_blank" class="btn btn-whatsapp">
                    <i class="fab fa-whatsapp"></i> Chat WA Reservasi
                </a>
            </form>

            <div class="chat-container" id="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message bot">
                        <div class="avatar">ü§ñ</div>
                        <div class="chat-bubble">
                            <p>Hello! I'm your booking assistant. You can ask me to help you book an appointment.</p>
                            <p><strong>Try saying:</strong></p>
                            <ul>
                                <li>Book me an appointment</li>
                                <li>I need to booking a Booking Restaurant</li>
                                <li>Available times tomorrow</li>
                                <li>My name is eden, email eden@example.com, phone +62823456789</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                    Assistant is typing...
                </div>

                <div class="chat-input-container">
                    <textarea id="chat-input" class="chat-input" placeholder="Type your message here..." rows="1"></textarea>
                    <button type="button" id="chat-send-btn" class="chat-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <div class="business-hours">
                <h4><i class="fas fa-clock"></i> Business Hours</h4>
                <ul>
                    <li><strong>Days:</strong> Monday to Friday</li>
                    <li><strong>Hours:</strong> 8:00 AM - 5:30 PM (Indonesia time)</li>
                    <li><strong>Last Booking:</strong> 5:00 PM (17:00)</li>
                </ul>
            </div>
        </div>

        <div class="test-scenarios">
            <h3><i class="fas fa-flask"></i> Quick Test Scenarios</h3>
            <p>Click any button to auto-fill the form with test data:</p>
            <button class="scenario-btn success" onclick="fillForm('valid')">‚úì Valid Booking</button>
            <button class="scenario-btn error" onclick="fillForm('weekend')">‚úó Weekend Booking</button>
            <button class="scenario-btn error" onclick="fillForm('invalid-email')">‚úó Invalid Email</button>
            <button class="scenario-btn error" onclick="fillForm('missing-fields')">‚úó Missing Fields</button>
        </div>
    </div>

    <div class="call-status" id="call-status">
        <div class="indicator"></div>
        <span id="status-text">Connected</span>
    </div>

    <button class="floating-call-btn" id="voice-call-btn" title="Voice Booking">
        <i class="fas fa-phone" id="call-icon"></i>
    </button>

    <script>
        // ===== VAPI SDK ROBUST LOADER WITH MULTIPLE CDN FALLBACK =====
        (function() {
            console.log('üîß Starting Vapi SDK robust loader...');
            
            const vapiCDNs = [
                'https://cdn.jsdelivr.net/npm/@vapi-ai/web@2.0.4/dist/index.js',
                'https://unpkg.com/@vapi-ai/web@2.0.4/dist/index.js',
                'https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/index.js',
                'https://unpkg.com/@vapi-ai/web@latest/dist/index.js'
            ];
            
            let currentCDNIndex = 0;
            let scriptElement = null;
            let loadTimeout = null;
            
            function loadVapiScript(url) {
                return new Promise((resolve, reject) => {
                    console.log(`üì• Loading Vapi from CDN ${currentCDNIndex + 1}/${vapiCDNs.length}: ${url}`);
                    
                    if (scriptElement && scriptElement.parentNode) {
                        scriptElement.parentNode.removeChild(scriptElement);
                    }
                    
                    scriptElement = document.createElement('script');
                    scriptElement.src = url;
                    scriptElement.async = true;
                    
                    scriptElement.onload = function() {
                        clearTimeout(loadTimeout);
                        
                        setTimeout(() => {
                            if (typeof Vapi !== 'undefined') {
                                console.log('‚úÖ Vapi SDK loaded successfully from:', url);
                                window.vapiSDKReady = true;
                                window.dispatchEvent(new Event('vapiReady'));
                                resolve(true);
                            } else {
                                console.warn('‚ö†Ô∏è Script loaded but Vapi not defined');
                                reject(new Error('Vapi not defined after script load'));
                            }
                        }, 300);
                    };
                    
                    scriptElement.onerror = function(error) {
                        clearTimeout(loadTimeout);
                        console.error('‚ùå Failed to load from:', url, error);
                        reject(error);
                    };
                    
                    loadTimeout = setTimeout(() => {
                        if (typeof Vapi === 'undefined') {
                            console.warn('‚ö†Ô∏è Timeout loading from:', url);
                            reject(new Error('Timeout loading Vapi SDK'));
                        }
                    }, 8000);
                    
                    document.head.appendChild(scriptElement);
                });
            }
            
            async function tryLoadVapi() {
                while (currentCDNIndex < vapiCDNs.length) {
                    try {
                        await loadVapiScript(vapiCDNs[currentCDNIndex]);
                        console.log('üéâ Vapi SDK successfully loaded!');
                        return true;
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è CDN ${currentCDNIndex + 1} failed:`, error.message);
                        currentCDNIndex++;
                        
                        if (currentCDNIndex < vapiCDNs.length) {
                            console.log(`üîÑ Trying next CDN (${currentCDNIndex + 1}/${vapiCDNs.length})...`);
                        }
                    }
                }
                
                console.error('‚ùå All CDN sources failed to load Vapi SDK');
                window.vapiSDKReady = false;
                window.dispatchEvent(new Event('vapiLoadFailed'));
                return false;
            }
            
            tryLoadVapi();
        })();

        // ===== CONFIGURATION =====
        const MAIN_URL_MAKE_BOOKING = 'https://template-n8n.b2cvzj.easypanel.host/webhook/book2';
        const MAIN_URL_CHECK_BOOKING = 'https://template-n8n.b2cvzj.easypanel.host/webhook/book4';
        const MAIN_URL_CHAT_BOOKING = 'https://template-n8n.b2cvzj.easypanel.host/webhook/chat-booking';
        const MAIN_URL_VOICE_INIT = 'https://template-n8n.b2cvzj.easypanel.host/webhook/voice-booking-init';
        const MAIN_URL_VOICE_BOOKING = 'https://template-n8n.b2cvzj.easypanel.host/webhook/voice-booking2';

        function checkTheme() {
            const urlParams = new URLSearchParams(window.location.search);
            const theme = urlParams.get('theme');
            const iframeMode = urlParams.get('iframeMode');

            if (theme === 'teal') {
                document.body.classList.add('teal-theme');
            }

            if (iframeMode === 'true') {
                document.body.classList.add('iframe-mode');
            }
        }

        checkTheme();

        // ===== GLOBAL VARIABLES =====
        let selectedTimeSlot = null;
        let availableSlots = [];
        let bookedSlots = [];
        let chatMode = false;
        let chatSessionId = null;
        let vapiInstance = null;
        let isCallActive = false;
        let callStartTime = null;
        window.vapiSDKReady = false;

        function generateSessionId() {
            return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function initChatSession() {
            chatSessionId = generateSessionId();
            console.log('üìù Chat session initialized:', chatSessionId);
        }

        // ===== VOICE AI FUNCTIONS =====

        async function waitForVapiSDK(maxWaitMs = 20000) {
            console.log('‚è≥ Waiting for Vapi SDK (max ' + (maxWaitMs/1000) + 's)...');
            const startTime = Date.now();
            
            return new Promise((resolve, reject) => {
                if (typeof Vapi !== 'undefined') {
                    console.log('‚úÖ Vapi already loaded');
                    resolve(true);
                    return;
                }
                
                const onVapiReady = () => {
                    console.log('‚úÖ Vapi ready event received');
                    cleanup();
                    resolve(true);
                };
                
                const onVapiLoadFailed = () => {
                    console.error('‚ùå Vapi load failed event received');
                    cleanup();
                    reject(new Error('All CDN sources failed. Check:\n1. Internet connection\n2. Ad blocker settings\n3. Firewall/proxy'));
                };
                
                const cleanup = () => {
                    clearInterval(checkInterval);
                    clearTimeout(timeoutHandle);
                    window.removeEventListener('vapiReady', onVapiReady);
                    window.removeEventListener('vapiLoadFailed', onVapiLoadFailed);
                };
                
                window.addEventListener('vapiReady', onVapiReady, { once: true });
                window.addEventListener('vapiLoadFailed', onVapiLoadFailed, { once: true });
                
                const checkInterval = setInterval(() => {
                    if (typeof Vapi !== 'undefined') {
                        console.log('‚úÖ Vapi detected via polling');
                        cleanup();
                        resolve(true);
                    }
                }, 200);
                
                const timeoutHandle = setTimeout(() => {
                    console.error('‚ùå Timeout waiting for Vapi SDK');
                    cleanup();
                    reject(new Error('SDK load timeout (' + (maxWaitMs/1000) + 's). Please refresh.'));
                }, maxWaitMs);
            });
        }

        function setupVapiEvents() {
            if (!vapiInstance) {
                console.warn('‚ö†Ô∏è Cannot setup events: vapiInstance is null');
                return;
            }

            console.log('üîß Setting up Vapi event listeners...');

            vapiInstance.on('call-start', () => {
                console.log('‚úÖ Call started');
                isCallActive = true;
                callStartTime = Date.now();
                updateCallUI(true);
                showToast('üé§ Voice call connected! Start speaking...', 'success');
            });

            vapiInstance.on('call-end', () => {
                console.log('üìû Call ended');
                isCallActive = false;
                
                const duration = callStartTime ? Math.round((Date.now() - callStartTime) / 1000) : 0;
                updateCallUI(false);
                showToast(`Call ended (${duration}s). Thank you!`, 'success');
                callStartTime = null;
            });

            vapiInstance.on('speech-start', () => {
                console.log('üé§ User speaking');
                const statusEl = document.getElementById('call-status');
                const textEl = document.getElementById('status-text');
                
                if (statusEl && textEl) {
                    statusEl.classList.remove('listening');
                    statusEl.classList.add('speaking');
                    textEl.textContent = 'Listening...';
                }
            });

            vapiInstance.on('speech-end', () => {
                console.log('ü§ê User stopped');
                const statusEl = document.getElementById('call-status');
                const textEl = document.getElementById('status-text');
                
                if (statusEl && textEl) {
                    statusEl.classList.remove('speaking');
                    statusEl.classList.add('listening');
                    textEl.textContent = 'Processing...';
                }
            });

            vapiInstance.on('error', (error) => {
                console.error('‚ùå Vapi error:', error);
                showToast('Voice error: ' + (error.message || 'Connection failed'), 'error');
                isCallActive = false;
                updateCallUI(false);
            });

            vapiInstance.on('message', (message) => {
                console.log('üí¨ Vapi message:', message);
            });

            console.log('‚úÖ Event listeners configured');
        }

        async function startVoiceCall() {
            try {
                console.log('üéôÔ∏è Initiating voice call...');
                showToast('üîÑ Checking voice system...', 'warning');
                
                try {
                    await waitForVapiSDK(20000);
                    console.log('‚úÖ Vapi SDK ready');
                } catch (error) {
                    throw new Error('Voice SDK not loaded:\n‚Ä¢ Check internet connection\n‚Ä¢ Disable ad blockers\n‚Ä¢ Allow scripts from CDN\n‚Ä¢ Refresh page');
                }
                
                showToast('üì° Connecting to voice assistant...', 'warning');
                
                console.log('üì° Fetching voice config from n8n...');
                const response = await fetch(MAIN_URL_VOICE_INIT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: chatSessionId || generateSessionId(),
                        timestamp: new Date().toISOString(),
                        source: 'web'
                    })
                });

                if (!response.ok) {
                    throw new Error(`N8N server error (HTTP ${response.status}). Check webhook status.`);
                }

                const config = await response.json();
                console.log('‚úÖ Config received:', {
                    success: config.success,
                    hasPublicKey: !!config.publicKey,
                    hasAssistantId: !!config.assistantId
                });

                if (!config.success || !config.publicKey || !config.assistantId) {
                    throw new Error('Invalid server config. Check n8n workflow response format.');
                }

                if (!vapiInstance) {
                    console.log('üîß Creating Vapi instance...');
                    vapiInstance = new Vapi(config.publicKey);
                    setupVapiEvents();
                }

                console.log('üìû Starting call with assistant:', config.assistantId);
                await vapiInstance.start(config.assistantId);
                
            } catch (error) {
                console.error('‚ùå Voice call error:', error);
                
                let errorMsg = '‚ùå Call failed: ';
                if (error.message.includes('SDK') || error.message.includes('CDN')) {
                    errorMsg = '‚ùå Voice SDK failed to load. Check internet & refresh page.';
                } else if (error.message.includes('server') || error.message.includes('HTTP')) {
                    errorMsg = '‚ùå Server error. Check n8n webhook is active.';
                } else if (error.message.includes('config')) {
                    errorMsg = '‚ùå Config error. Check n8n response format.';
                } else if (error.message.includes('microphone')) {
                    errorMsg = '‚ùå Microphone access denied. Check browser permissions.';
                } else {
                    errorMsg += error.message.split('\n')[0];
                }
                
                showToast(errorMsg, 'error');
                isCallActive = false;
                updateCallUI(false);
            }
        }

        function stopVoiceCall() {
            if (vapiInstance && isCallActive) {
                console.log('üõë Stopping call...');
                vapiInstance.stop();
                showToast('Ending call...', 'warning');
            }
        }

        function toggleVoiceCall() {
            console.log('üîÑ Toggle call. Active:', isCallActive);
            
            if (!isCallActive) {
                startVoiceCall();
            } else {
                stopVoiceCall();
            }
        }

        function updateCallUI(active) {
            const btn = document.getElementById('voice-call-btn');
            const icon = document.getElementById('call-icon');
            const status = document.getElementById('call-status');
            
            if (!btn || !icon || !status) return;
            
            if (active) {
                btn.classList.add('calling');
                icon.className = 'fas fa-phone-slash';
                status.classList.add('active', 'listening');
                document.getElementById('status-text').textContent = 'Connected';
            } else {
                btn.classList.remove('calling');
                icon.className = 'fas fa-phone';
                status.classList.remove('active', 'listening', 'speaking');
            }
        }

        // ===== OTHER FUNCTIONS =====

        function markdownToHtml(markdown) {
            return markdown
                .replace(/### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/# (.*?)$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                .replace(/\n/g, '<br>')
                .replace(/<br><br>/g, '</p><p>')
                .replace(/^(.+)$/gm, '<p>$1</p>')
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[1-3]>.*?<\/h[1-3]>)<\/p>/g, '$1')
                .replace(/- (.*?)<br>/g, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>')
                .replace(/<\/ul><br><ul>/g, '');
        }

        function toggleMode() {
            chatMode = !chatMode;

            const toggle = document.getElementById('mode-toggle');
            const formLabel = document.getElementById('form-label');
            const chatLabel = document.getElementById('chat-label');
            const bookingForm = document.getElementById('booking-form');
            const chatContainer = document.getElementById('chat-container');
            const businessHours = document.querySelector('.business-hours');
            const testScenarios = document.querySelector('.test-scenarios');

            if (chatMode) {
                toggle.classList.add('active');
                formLabel.classList.remove('active');
                chatLabel.classList.add('active');
                bookingForm.style.display = 'none';
                chatContainer.classList.add('active');
                businessHours.style.display = 'none';
                if (testScenarios) testScenarios.style.display = 'none';

                if (!chatSessionId) {
                    initChatSession();
                }
            } else {
                toggle.classList.remove('active');
                formLabel.classList.add('active');
                chatLabel.classList.remove('active');
                bookingForm.style.display = 'block';
                chatContainer.classList.remove('active');
                businessHours.style.display = 'block';
                if (testScenarios) testScenarios.style.display = 'block';
            }
        }

        function addChatMessage(message, isUser = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user' : 'bot'}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = isUser ? 'üë§' : 'ü§ñ';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';

            if (isUser) {
                bubble.textContent = message;
            } else {
                bubble.innerHTML = markdownToHtml(message);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typing-indicator').classList.add('show');
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator').classList.remove('show');
        }

        async function sendChatMessage(message) {
            if (!message.trim()) return;

            addChatMessage(message, true);
            showTypingIndicator();

            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;

            try {
                const response = await fetch(MAIN_URL_CHAT_BOOKING, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat: message,
                        unique: chatSessionId
                    })
                });

                const data = await response.json();

                hideTypingIndicator();

                let botMessage;
                if (typeof data === 'string') {
                    botMessage = data;
                } else if (Array.isArray(data) && data.length > 0 && data[0].output) {
                    botMessage = data[0].output;
                } else if (typeof data === 'object' && data.output) {
                    botMessage = data.output;
                } else if (typeof data === 'object' && data.message) {
                    botMessage = data.message;
                } else {
                    botMessage = "Sorry, I encountered an error. Please try again.";
                }

                addChatMessage(botMessage, false);

            } catch (error) {
                console.error('Chat error:', error);
                hideTypingIndicator();
                addChatMessage("Sorry, I encountered an error. Please try again.", false);
            } finally {
                sendBtn.disabled = false;
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        const testScenarios = {
            'valid': {
                name: 'John Doe',
                email: 'john@example.com',
                phone: '+62123456789',
                date: getNextWeekday(),
                partySize: 4,
                allergies: '',
                specialRequests: 'Window seat please'
            },
            'weekend': {
                name: 'Weekend User',
                email: 'weekend@example.com',
                phone: '+62123456790',
                date: getNextWeekend(),
                partySize: 2,
                allergies: 'Peanuts',
                specialRequests: ''
            },
            'invalid-email': {
                name: 'Bad Email User',
                email: 'invalid-email',
                phone: '+62123456793',
                date: getNextWeekday(),
                partySize: 1,
                allergies: '',
                specialRequests: ''
            },
            'missing-fields': {
                name: '',
                email: '',
                phone: '',
                date: '',
                partySize: 1,
                allergies: '',
                specialRequests: ''
            }
        };

        function getNextWeekday() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            while (tomorrow.getDay() === 0 || tomorrow.getDay() === 6) {
                tomorrow.setDate(tomorrow.getDate() + 1);
            }

            return tomorrow.toISOString().split('T')[0];
        }

        function getNextWeekend() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            while (tomorrow.getDay() !== 0 && tomorrow.getDay() !== 6) {
                tomorrow.setDate(tomorrow.getDate() + 1);
            }

            return tomorrow.toISOString().split('T')[0];
        }

        function fillForm(scenario) {
            const data = testScenarios[scenario];
            if (!data) return;

            document.getElementById('name').value = data.name;
            document.getElementById('email').value = data.email;
            document.getElementById('phone').value = data.phone;
            document.getElementById('date').value = data.date;
            document.getElementById('partysize').value = data.partySize + 1;
            document.getElementById('allergies').value = data.allergies;
            document.getElementById('notes').value = data.specialRequests;

            if (data.date) {
                checkDateAndLoadSlots(data.date);
            }
        }

        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : (type === 'warning' ? 'exclamation-circle' : 'check-circle')}"></i>${message}`;

            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 5000);
        }

        function checkDateAndLoadSlots(date) {
            const timeSlotsGrid = document.getElementById('time-slots-grid');
            const submitBtn = document.getElementById('submit-btn');

            const today = new Date();
            const selectedDate = new Date(date);
            today.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);

            if (selectedDate < today) {
                timeSlotsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc2626; font-weight: 500;"><i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>Cannot book appointments for dates earlier than today</div>';
                submitBtn.disabled = true;
                return;
            }

            timeSlotsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">Loading time slots...</div>';
            submitBtn.disabled = true;

            fetch(MAIN_URL_CHECK_BOOKING, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ date: date })
            })
            .then(response => response.text())
            .then(text => {
                if (!text || text.trim() === '') {
                    throw new Error('Server returned empty response');
                }

                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error('Invalid JSON response from server');
                }
            })
            .then(data => {
                if (data.success) {
                    if (data.isHoliday) {
                        timeSlotsGrid.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc2626;">${data.holidayMessage}</div>`;
                        submitBtn.disabled = true;
                        return;
                    }

                    if (data.isWeekend) {
                        timeSlotsGrid.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc2626;">${data.weekendMessage}</div>`;
                        submitBtn.disabled = true;
                        return;
                    }

                    availableSlots = data.availableSlots;
                    loadTimeSlots(availableSlots);
                } else {
                    showToast(data.error || 'Failed to check date availability', 'error');
                    timeSlotsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc2626;">Error loading time slots</div>';
                }
            })
            .catch(error => {
                console.error('Error checking date:', error);
                showToast('Error checking date availability', 'error');
                timeSlotsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc2626;">Error loading time slots</div>';
            });
        }

        function loadTimeSlots(slots) {
            const timeSlotsGrid = document.getElementById('time-slots-grid');
            const submitBtn = document.getElementById('submit-btn');

            if (!slots || slots.length === 0) {
                timeSlotsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">No time slots available for this date</div>';
                submitBtn.disabled = true;
                return;
            }

            timeSlotsGrid.innerHTML = '';

            slots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.textContent = slot.display;
                slotElement.dataset.time = slot.time;

                if (slot.available === false) {
                    slotElement.classList.add('booked');
                    slotElement.title = 'This slot is already booked';
                } else {
                    slotElement.addEventListener('click', () => selectTimeSlot(slotElement, slot.time));
                }

                timeSlotsGrid.appendChild(slotElement);
            });

            submitBtn.disabled = false;
        }

        function selectTimeSlot(element, time) {
            document.querySelectorAll('.time-slot.selected').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedTimeSlot = time;
            console.log('Selected time slot:', time);
        }

        document.getElementById('date').addEventListener('change', function(e) {
            const selectedDate = e.target.value;
            if (selectedDate) {
                checkDateAndLoadSlots(selectedDate);
                selectedTimeSlot = null;
            }
        });

        document.getElementById('booking-form').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!selectedTimeSlot) {
                showToast('Please select a time slot', 'error');
                return;
            }

            const formData = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                date: document.getElementById('date').value,
                time: selectedTimeSlot,
                partySize: document.getElementById('partysize').value,
                allergies: document.getElementById('allergies').value.trim(),
                specialRequests: document.getElementById('notes').value.trim(),
                source: 'Booking System'
            };

            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitButton.disabled = true;

            fetch(MAIN_URL_MAKE_BOOKING, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.confirmationMessage || 'Booking confirmed!', 'success');

                    const urlParams = new URLSearchParams(window.location.search);
                    const iframeMode = urlParams.get('iframeMode');

                    if (iframeMode === 'true') {
                        window.parent.postMessage({
                            type: 'booking-submitted',
                            success: true,
                            data: data
                        }, '*');
                    }

                    this.reset();
                    selectedTimeSlot = null;
                    document.getElementById('time-slots-grid').innerHTML = '';
                    submitButton.disabled = true;
                } else {
                    showToast(data.error || data.message || 'Booking failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error: ' + error.message, 'error');
            })
            .finally(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });

        document.getElementById('date').value = getNextWeekday();

        setTimeout(() => {
            checkDateAndLoadSlots(getNextWeekday());
        }, 100);

        document.getElementById('mode-toggle').addEventListener('click', toggleMode);

        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');

        chatInput.addEventListener('input', function() {
            autoResizeTextarea(this);
        });

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = this.value.trim();
                if (message) {
                    sendChatMessage(message);
                    this.value = '';
                    autoResizeTextarea(this);
                }
            }
        });

        chatSendBtn.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message) {
                sendChatMessage(message);
                chatInput.value = '';
                autoResizeTextarea(chatInput);
            }
        });

        initChatSession();

        document.getElementById('voice-call-btn').addEventListener('click', function() {
            console.log('üéØ Voice button clicked');
            toggleVoiceCall();
        });

        window.addEventListener('load', function() {
            console.log('üì± Page loaded');
            console.log('üéôÔ∏è Vapi SDK status:', typeof Vapi !== 'undefined' ? '‚úÖ Loaded' : '‚è≥ Loading...');
        });
    </script>
</body>
</html>
